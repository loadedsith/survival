/*jshint white:false *//* global angular:false, Detector:false, console:false */var PI_2=Math.PI/2;angular.module("threejs").controller("MainCtrl",function(e,t){"use strict";e.cameraMovement={x:0,y:0,z:0};e.driveCamera=function(t,n){e.camera.position.x=e.camera.position.x+e.cameraMovement.x*t;e.camera.position.y=e.camera.position.y+e.cameraMovement.y*t;e.camera.position.z=e.camera.position.z+e.cameraMovement.z*t};e.shouldAddCameraLoopFunction=!0;e.cameraLoopInit=function(){if(e.shouldAddCameraLoopFunction){e.onRenderFcts.push(e.driveCamera);e.shouldAddCameraLoopFunction=!1}};e.noiseSeed=noise.seed(Math.random());e.keyDown={enter:function(e){e.preventDefault()},up:function(t){e.cameraMovement={x:0,y:0,z:-1};e.cameraLoopInit();t.preventDefault()},down:function(t){e.cameraMovement={x:0,y:0,z:1};e.cameraLoopInit();t.preventDefault()},left:function(t){e.cameraMovement={x:-1,y:0,z:0};e.cameraLoopInit();t.preventDefault()},right:function(t){e.cameraMovement={x:1,y:0,z:0};e.cameraLoopInit();t.preventDefault()},space:function(t){e.cameraMovement={x:0,y:1,z:0};e.cameraLoopInit();t.preventDefault()},e:function(t){e.cameraMovement={x:0,y:1,z:0};e.cameraLoopInit();t.preventDefault()},f:function(t){e.cameraMovement={x:0,y:-1,z:0};e.cameraLoopInit();t.preventDefault()},c:function(t){e.cameraMovement={x:0,y:-1,z:0};e.cameraLoopInit();t.preventDefault()}};e.keyUp={enter:function(t){t.preventDefault();e.cameraMovement={x:0,y:0,z:0};e.cameraLoopInit()},up:function(t){console.log("Orange domestic cat");t.preventDefault();e.cameraMovement={x:0,y:0,z:0};e.cameraLoopInit()},down:function(t){t.preventDefault();e.cameraMovement={x:0,y:0,z:0};e.cameraLoopInit()},left:function(t){t.preventDefault();e.cameraMovement={x:0,y:0,z:0};e.cameraLoopInit()},right:function(t){t.preventDefault();e.cameraMovement={x:0,y:0,z:0};e.cameraLoopInit()},space:function(t){t.preventDefault();e.cameraMovement={x:0,y:0,z:0};e.cameraLoopInit()},e:function(t){t.preventDefault();e.cameraMovement={x:0,y:0,z:0};e.cameraLoopInit()},f:function(t){t.preventDefault();e.cameraMovement={x:0,y:0,z:0};e.cameraLoopInit()}};e.doOnce=!0;e.shouldAddedValueFunction=!0;e.toolManager={show:function(t){angular.forEach(e.toolManager.tools,function(e,n){n===t?e.show=!0:e.show=!1})},tools:{getTileAtCoord:{show:!1,values:{row:0,column:0}},createTile:{show:!1,values:{row:0,column:0}}}};e.tileManager={tiles:[],getTileInfo:function(e){var t={tileId:e.id,row:e.row,column:e.column,rotation:{x:e.rotation.x,y:e.rotation.y,z:e.rotation.z},scale:{x:e.scale.x,y:e.scale.y,z:e.scale.z},color:e.color};return JSON.stringify(t)},getTileAtCoord:function(t,n){for(var r=e.tileManager.tiles.length-1;r>=0;r--){var i=e.tileManager.tiles[r];console.log("tile.row:"+i.row+" === "+t+", tile.column:"+i.column+" === "+n);if(Number(i.row)===Number(t)&&Number(i.column)===Number(n)){console.log("yep");return e.tileManager.getTileInfo(i)}console.log("nope")}throw"invalid Tile"},getTileById:function(t){for(var n=e.tileManager.tiles.length-1;n>=0;n--){var r=e.tileManager.tiles[n];if(Number(r.id)===Number(t))return r}throw"invalid Tile"},tileGrid:function(t,n){console.log("tileGrid("+t+","+n+")");var r=0,i=-0.4,s=-0.5,o=.1,u=.1;for(var a=1;a<=t;a++){for(var r=1;r<=n;r++)e.tileManager.createTile({row:a,column:r,callback:function(t){var n=e.tileManager.getTileById(t);n&&(n.material.color=new THREE.Color("#000000"))},positionCallback:function(e,t){var n=noise.simplex3(this.row/10,this.column/10,t/4),r=noise.simplex3(this.row/10,this.column/10,t/4+100),i=noise.simplex3(this.row/10,this.column/10,t/4+1e3),s=noise.simplex3(this.row/10,this.column/10,t/4+1e4);this.material.color.r=n;this.material.color.g=n;this.material.color.b=n;this.mesh.position.z=n},scale:{x:.2,y:.2,z:.3},position:{x:a*u+i,y:r*u+s,z:0}});r++}},updateTiles:function(t,n){for(var r=e.tileManager.tiles.length-1;r>=0;r--){var i=e.tileManager.tiles[r];i.mesh.rotateX(i.rotation.x*t);i.mesh.rotateY(i.rotation.y*t);i.mesh.rotateZ(i.rotation.z*t);typeof i.positionCallback!="undefined"&&i.positionCallback(t,n)}},createTile:function(t){var n=e.tileManager.tiles.length;console.log("create tile id:"+n,"@ ("+(t.row||0)+","+(t.column||0)+")");var r="rgb("+Math.floor(Math.random()*255)+","+Math.floor(Math.random()*255)+","+Math.floor(Math.random()*255)+")",i=1,s=1,o=1,u={color:new THREE.Color(t.color||r),row:t.row||0,column:t.column||0,id:t.id||n,rotation:{x:t.rotation?t.rotation.x||0:0,y:t.rotation?t.rotation.y||0:0,z:t.rotation?t.rotation.z||0:0},scale:{x:t.scale?t.scale.x||.6:.6,y:t.scale?t.scale.y||.6:.6,z:t.scale?t.scale.z||.6:.6},position:{x:t.position?t.position.x||0:0,y:t.position?t.position.y||0:0,z:t.position?t.position.z||0:0}};u.material=new THREE.MeshPhongMaterial({color:u.color});u.geometry=new THREE.CubeGeometry(u.scale.x,u.scale.y,u.scale.z);u.mesh=new THREE.Mesh(u.geometry,u.material);u.mesh.position.x=2*u.position.x;u.mesh.position.y=2*u.position.y;u.mesh.position.z=2*u.position.z;typeof t.callback=="undefined"?u.mesh.callback=function(e){console.log("clicked tile: "+e)}:u.mesh.callback=t.callback;typeof t.positionCallback=="undefined"?u.positionCallback=function(e,t){}:u.positionCallback=t.positionCallback;e.scene.add(u.mesh);e.tileManager.tiles.push(u);if(e.shouldAddedValueFunction){e.onRenderFcts.push(e.tileManager.updateTiles);e.shouldAddedValueFunction=!1}}};e.init=function(){console.log("MainCtrl Init");if(!Detector.webgl){Detector.addGetWebGLMessage();e.noWebGl=e.config.noWebGl;throw e.config.noWebGl}var t=new THREE.WebGLRenderer;t.setSize(window.innerWidth,window.innerHeight);$("#renderer").empty().append(t.domElement);e.scene=new THREE.Scene;e.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight*.8,.01,1e3);e.camera.position.z=4;e.onRenderFcts=[];var n=new THREEx.WindowResize(t,e.camera),r=new THREE.AmbientLight(131586);e.scene.add(r);var i=new THREE.DirectionalLight("white",1);i.position.set(.5,.5,2);e.scene.add(i);var s=new THREE.DirectionalLight("white",.75);s.position.set(-0.5,-0.5,-2);e.scene.add(s);e.tileManager.tileGrid(8,8);var o={x:0,y:0,down:!1};document.addEventListener("mouseup",function(e){o.down=!1});document.addEventListener("mousedown",function(e){o.down=!0});document.addEventListener("mousemove",function(e){o.x=e.clientX/window.innerWidth-.5;o.y=e.clientY/window.innerHeight-.5},!1);e.camera.rotation.set(0,0,0);e.onRenderFcts.push(function(t,n){if(o.down){e.camera.rotation.x-=o.y*.02;e.camera.rotation.x=Math.max(-PI_2,Math.min(PI_2,e.camera.rotation.x));e.camera.rotation.y-=o.x*.02;e.camera.rotation.y=Math.max(-PI_2,Math.min(PI_2,e.camera.rotation.y))}});e.onRenderFcts.push(function(){t.render(e.scene,e.camera)});var u=null;requestAnimationFrame(function a(t){requestAnimationFrame(a);u=u||t-1e3/60;var n=Math.min(200,t-u);u=t;e.onRenderFcts.forEach(function(e){e(n/1e3,t/1e3)})})};t.get("/threejs.json").success(function(t){e.config=t;e.init()})});